<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=account_circle,logout,settings,dashboard,person,menu,close,search,notifications,home,school,trending_up,groups,auto_awesome,edit,delete,save,cancel" />

<header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50">
  <nav class="container mx-auto px-4 py-4 flex items-center justify-between">
    <!-- Logo -->
    <a href="/index.html" class="text-2xl font-bold text-blue-600 dark:text-blue-400 flex-shrink-0">EduRise</a>

    <!-- Navigation Links -->
    <div class="hidden md:flex items-center gap-6 flex-1 mx-8">
      <a href="/index.html" class="hover:text-blue-600 dark:hover:text-blue-400 transition">Home</a>
      <a href="/learn.html" class="hover:text-blue-600 dark:hover:text-blue-400 transition">Learn</a>
      <a href="/roles.html" class="hover:text-blue-600 dark:hover:text-blue-400 transition">Roles</a>
      <a href="/pathways.html" class="hover:text-blue-600 dark:hover:text-blue-400 transition">Pathways</a>
      <a href="/ai.html" class="hover:text-blue-600 dark:hover:text-blue-400 transition">AI Mentor</a>
      <a href="/forum.html" class="hover:text-blue-600 dark:hover:text-blue-400 transition">Forum</a>
      <a href="/gamification.html" class="hover:text-blue-600 dark:hover:text-blue-400 transition">Gamification</a>
    </div>

    <!-- Right Side: Theme, Profile/Auth, Menu -->
    <div class="flex items-center gap-4">
      <!-- Theme Toggle -->
      <button id="theme-toggle" class="p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition" aria-label="Toggle theme">
        <span class="material-symbols-outlined text-2xl">light_mode</span>
      </button>

      <!-- Auth Section -->
      <div id="auth-container" class="flex items-center gap-3">
        <!-- User Logged In (Hidden by default) -->
        <div id="user-menu" class="hidden relative">
          <!-- Profile Icon / Avatar - VISIBLE ON ALL PAGES -->
          <button id="profile-menu-btn" class="group relative flex items-center gap-2 p-2 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900 transition duration-200" aria-label="User menu" title="Click to open settings">
            <!-- Avatar with animated border using Material Symbol -->
            <div class="relative">
              <span class="material-symbols-outlined w-10 h-10 rounded-full text-3xl text-blue-500 group-hover:text-blue-600 transition flex items-center justify-center border-2 border-blue-500 group-hover:border-blue-600">account_circle</span>
              <!-- Notification dot -->
              <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white dark:border-gray-800"></div>
            </div>
            <!-- User name and dropdown indicator -->
            <div class="hidden sm:flex flex-col items-start">
              <span id="user-display-name" class="text-sm font-bold text-gray-900 dark:text-white leading-none"></span>
              <span class="text-xs text-gray-500 dark:text-gray-400">Settings</span>
            </div>
            <!-- Dropdown arrow using Material Symbol -->
            <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 group-hover:rotate-180 transition">expand_more</span>
          </button>

          <!-- Dropdown Menu -->
          <div id="profile-dropdown" class="absolute right-0 mt-2 w-56 bg-white dark:bg-gray-700 rounded-xl shadow-2xl hidden z-50 overflow-hidden border border-gray-200 dark:border-gray-600">
            <!-- Header with user info -->
            <div class="px-4 py-4 bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/30 border-b border-gray-200 dark:border-gray-600">
              <div class="flex items-center gap-3">
                <img id="dropdown-avatar" src="" alt="Profile" class="w-12 h-12 rounded-full object-cover border-3 border-blue-500">
                <div class="flex-1 min-w-0">
                  <p id="dropdown-name" class="font-bold text-gray-900 dark:text-white truncate"></p>
                  <p id="dropdown-email" class="text-xs text-gray-600 dark:text-gray-400 truncate"></p>
                </div>
              </div>
            </div>
            
            <!-- Menu items -->
            <div class="py-2">
              <a href="/profile.html" class="flex items-center gap-3 px-4 py-3 hover:bg-blue-50 dark:hover:bg-gray-600 transition">
                <span class="material-symbols-outlined text-xl">person</span>
                <div>
                  <p class="font-semibold text-sm text-gray-900 dark:text-white">Profile</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">View your profile</p>
                </div>
              </a>
              <a href="/dashboard.html" class="flex items-center gap-3 px-4 py-3 hover:bg-blue-50 dark:hover:bg-gray-600 transition">
                <span class="material-symbols-outlined text-xl">dashboard</span>
                <div>
                  <p class="font-semibold text-sm text-gray-900 dark:text-white">Dashboard</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">Your progress</p>
                </div>
              </a>
              <a href="/settings.html" class="flex items-center gap-3 px-4 py-3 hover:bg-blue-50 dark:hover:bg-gray-600 transition border-t border-gray-200 dark:border-gray-600">
                <span class="material-symbols-outlined text-xl">settings</span>
                <div>
                  <p class="font-semibold text-sm text-gray-900 dark:text-white">Settings</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">Preferences & privacy</p>
                </div>
              </a>
            </div>

            <!-- Footer -->
            <div class="px-4 py-3 border-t border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-800">
              <button id="logout-btn" class="w-full flex items-center gap-3 text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 font-semibold transition">
                <span class="material-symbols-outlined text-xl">logout</span>
                Sign Out
              </button>
            </div>
          </div>
        </div>

        <!-- Sign In Button (Shown when not logged in) -->
        <a id="signin-btn" href="/auth.html" class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold text-sm">
          Sign In
        </a>
      </div>

      <!-- Mobile Menu Toggle -->
      <button id="mobile-menu-toggle" class="md:hidden p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700" aria-label="Toggle mobile menu">
        <span class="material-symbols-outlined text-2xl">menu</span>
      </button>
    </div>
  </nav>

  <!-- Mobile Navigation Menu -->
  <div id="mobile-menu" class="hidden md:hidden bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600">
    <nav class="container mx-auto px-4 py-4 flex flex-col gap-3">
      <a href="/index.html" class="px-3 py-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">Home</a>
      <a href="/learn.html" class="px-3 py-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">Learn</a>
      <a href="/roles.html" class="px-3 py-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">Roles</a>
      <a href="/pathways.html" class="px-3 py-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">Pathways</a>
      <a href="/ai.html" class="px-3 py-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">AI Mentor</a>
      <a href="/forum.html" class="px-3 py-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">Forum</a>
      <a href="/gamification.html" class="px-3 py-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">Gamification</a>
    </nav>
  </div>
</header>

<script src="/js/session.js"></script>
<script>
  (function() {
    // DOM Elements
    const authContainer = document.getElementById('auth-container');
    const userMenu = document.getElementById('user-menu');
    const signinBtn = document.getElementById('signin-btn');
    const profileMenuBtn = document.getElementById('profile-menu-btn');
    const profileDropdown = document.getElementById('profile-dropdown');
    const logoutBtn = document.getElementById('logout-btn');
    const userAvatar = document.getElementById('user-avatar');
    const dropdownAvatar = document.getElementById('dropdown-avatar');
    const userDisplayName = document.getElementById('user-display-name');
    const dropdownName = document.getElementById('dropdown-name');
    const dropdownEmail = document.getElementById('dropdown-email');
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');

    // Generate default avatar URL
    function getDefaultAvatar(name, email) {
      const displayName = name || email.split('@')[0] || 'User';
      return `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=0D8ABC&color=fff&size=128&bold=true`;
    }

    // Initialize header
    function initHeader() {
      const currentUser = localStorage.getItem('currentUser');
      
      if (currentUser) {
        try {
          const user = JSON.parse(currentUser);
          showUserMenu(user);
        } catch (e) {
          console.error('Error parsing user:', e);
          showSigninButton();
        }
      } else {
        showSigninButton();
      }
    }

    function showUserMenu(user) {
      signinBtn?.classList.add('hidden');
      userMenu?.classList.remove('hidden');

      // Get profile data
      const profiles = JSON.parse(localStorage.getItem('user_profile') || '{}');
      const profile = profiles[user.uid] || {};

      // Generate avatar URL
      const avatarUrl = profile.photoURL || getDefaultAvatar(user.name || profile.name, user.email);

      // Update main avatar (visible in navbar)
      userAvatar.src = avatarUrl;
      userAvatar.alt = user.name || user.email;
      
      // Update dropdown avatar
      dropdownAvatar.src = avatarUrl;
      dropdownAvatar.alt = user.name || user.email;

      // Update display names
      const displayName = user.name || profile.name || user.email.split('@')[0];
      userDisplayName.textContent = displayName;
      dropdownName.textContent = displayName;
      
      // Update email
      dropdownEmail.textContent = user.email;

      // Add click to settings
      profileMenuBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        // Open settings directly on single click
        window.location.href = '/settings.html';
      });
    }

    function showSigninButton() {
      signinBtn?.classList.remove('hidden');
      userMenu?.classList.add('hidden');
    }

    // Profile menu toggle (for dropdown)
    profileMenuBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      profileDropdown?.classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!userMenu?.contains(e.target)) {
        profileDropdown?.classList.add('hidden');
      }
    });

    // Close dropdown when clicking a link
    profileDropdown?.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        profileDropdown?.classList.add('hidden');
      });
    });

    // Logout
    logoutBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm('Sign out from your account?')) {
        localStorage.removeItem('currentUser');
        window.location.href = '/auth.html';
      }
    });

    // Theme toggle
    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle) {
      const theme = localStorage.getItem('app_theme') || localStorage.getItem('theme') || 'auto';
      updateThemeToggle(theme);

      themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 
                           (document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('app_theme', newTheme);
        updateThemeToggle(newTheme);
      });
    }

    function updateThemeToggle(theme) {
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
        const icon = themeToggle.querySelector('.material-symbols-outlined');
        if (icon) icon.textContent = 'dark_mode';
      } else if (theme === 'light') {
        document.documentElement.classList.remove('dark');
        const icon = themeToggle.querySelector('.material-symbols-outlined');
        if (icon) icon.textContent = 'light_mode';
      } else {
        // Auto
        const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (isDark) {
          document.documentElement.classList.add('dark');
          const icon = themeToggle.querySelector('.material-symbols-outlined');
          if (icon) icon.textContent = 'dark_mode';
        } else {
          document.documentElement.classList.remove('dark');
          const icon = themeToggle.querySelector('.material-symbols-outlined');
          if (icon) icon.textContent = 'light_mode';
        }
      }
    }

    // Mobile menu toggle
    mobileMenuToggle?.addEventListener('click', () => {
      mobileMenu?.classList.toggle('hidden');
    });

    // Close mobile menu when clicking a link
    mobileMenu?.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        mobileMenu?.classList.add('hidden');
      });
    });

    // Listen for auth changes (storage event)
    window.addEventListener('storage', (e) => {
      if (e.key === 'currentUser') {
        initHeader();
      }
    });

    // Initialize on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initHeader);
    } else {
      initHeader();
    }

    // Update header every 5 seconds to catch session changes
    setInterval(initHeader, 5000);

    // Update when profile is edited
    window.addEventListener('profileUpdated', initHeader);
  })();
</script>
